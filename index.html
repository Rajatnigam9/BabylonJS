<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/ammo.js"></script>
        <script src="https://preview.babylonjs.com/cannon.js"></script>
        <script src="https://preview.babylonjs.com/Oimo.js"></script>
        <script src="https://preview.babylonjs.com/gltf_validator.js"></script>
        <script src="https://preview.babylonjs.com/earcut.min.js"></script>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
        <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                <!-- touch-action: none; -->
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>
	<!-- <script src="./script.js"></script> -->
    <script>
        var canvas = document.getElementById("renderCanvas");
        var createScene = function () {
        
            // --------------------------
            // Can change options as needed
            // --------------------------
        
            // detail range 1 to 5 : show detail in range 0 to detail_count-1
            var detail_count = 5;
        
            // texture selection
            var texture;
            texture_ref = "http://jerome.bousquie.fr/BJS/images/testTexture.jpg"
            texture = texture_ref; // only one available so far
        var faceUV = new Array(20);
        var columns =  4;  // 3 sprites per raw ie colums horizontally as shown in the image
        var rows =  4;  // 2 sprite raws as shown in the image above.
        for (var i = 0; i < 16; i++) {
                var y=i+1;
                var val=i-(Math.floor(i/4)*4);
                if(i<4)
                {
                faceUV[i] = new BABYLON.Vector4((val+1)/columns, 0/rows, (val)/columns, 1/rows);
                }
                else
                if(i<8)
                {
                faceUV[i] = new BABYLON.Vector4((val+1)/columns, 3/rows, (val)/columns, 4/rows);
                }
                else if(i<12)
                {
                faceUV[i] = new BABYLON.Vector4((val+1)/columns, 2/rows, (val)/columns, 3/rows);
                }
                else
                {
                faceUV[i] = new BABYLON.Vector4((val+1)/columns, 1/rows, (val)/columns, 2/rows);
                }
            }
            // --------------------------
            // End of options
            // --------------------------
        
            // Now create a basic Babylon Scene object
            var scene = new BABYLON.Scene(engine);
			scene.enablePhysics();

			// Physics engine
			var physicsViewer = new BABYLON.Debug.PhysicsViewer();
			var physicsHelper = new BABYLON.PhysicsHelper(scene);	
            // Change the scene background color to dark gray.
            scene.clearColor = new BABYLON.Color3(0.1, 0.1, 0.1);
        
            // This creates and positions a free camera
            //var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 5, -10), scene);
            var camera = new BABYLON.ArcRotateCamera(
                    "ArcRotateCamera", 0, 0, 0,
                    new BABYLON.Vector3(0.0, 1.0, 0.0),
                    scene);
            camera.setPosition(new BABYLON.Vector3(10, 1, 0));
            camera.inertia = 0;
            camera.angularSensibilityX = 250;
            camera.angularSensibilityY = 250;
            // This targets the camera to scene origin
            camera.setTarget(BABYLON.Vector3.Zero());
        
            // This attaches the camera to the canvas
            camera.attachControl(canvas, true);
        
            // --------------------------
            // Set up 2 light source rotating around enlight the icosphere 
            // --------------------------
        
             var light0 = new BABYLON.PointLight("light0_point", new BABYLON.Vector3(1, 5, 1), scene);
             light0.diffuse = BABYLON.Color3.Green();
             light0.specular = BABYLON.Color3.Black();
             light0.intensity = 0.9;
             var light1 = new BABYLON.PointLight("light1_point", new BABYLON.Vector3(5, 1, 1), scene);
             light1.diffuse = BABYLON.Color3.Red(); // Red
             light1.specular = BABYLON.Color3.Black();
             light1.intensity = 0.9;
             // This creates a light, aiming 0,1,0 - to the sky.
             var hemi_light1 = new BABYLON.HemisphericLight("light1_hemi", new BABYLON.Vector3(0, 15, 0), scene);
             // Tune intensity
             hemi_light1.intensity = 0.8;
             hemi_light1.specular = BABYLON.Color3.Black();
             hemi_light1.diffuse = BABYLON.Color3.White();
             hemi_light1.groundColor = BABYLON.Color3.Black();
        
            // ----------------------------------------------
            // Purpose of the playground : show the icosphere
            // ----------------------------------------------
        var boxImpostorParams = { mass: 10, restitution: 0, friction: 0.01 };
            // Create 'Ico sphere' shape. Params: name, radius, flat, subdivide, scene
			//var sphere1 =BABYLON.Mesh.CreateIcoSphere("icosphere", {radius:2, flat:true, subdivisions: 12}, scene);
			//sphere1.material = new BABYLON.StandardMaterial("qwerty", scene);
			//sphere1.material.wireframe = true;
            var sphere0 =BABYLON.MeshBuilder.CreatePolyhedron("oct", {type: 3, size: 1.75,faceUV:faceUV}, scene); 
            sphere0.material = new BABYLON.StandardMaterial("hoho", scene);            
            sphere0.material.diffuseColor = BABYLON.Color3.White(); // base color for diffuse before reflect
            sphere0.material.diffuseTexture = new BABYLON.Texture(texture,scene);
			//sphere0.physicsImpostor = new BABYLON.PhysicsImpostor(sphere0, BABYLON.PhysicsImpostor.MeshImpostor, boxImpostorParams, scene);
			//physicsViewer.showImpostor(sphere0.physicsImpostor);
            // Add the highlight layer.
        	var hl = new BABYLON.HighlightLayer("hl1", scene);
        	hl.addMesh(sphere0, BABYLON.Color3.Green());
            
            // Move the sphere upward 1/2 its height
            sphere0.position.y = 0;
        window.addEventListener("click", function () {
           // We try to pick an object
           var pickResult = scene.pick(scene.pointerX, scene.pointerY);
           if(pickResult.hit)
           {
           var indices = pickResult.pickedMesh.getIndices();
			alert(pickResult.faceId+1);
			sphere0.physicsImpostor = new BABYLON.PhysicsImpostor(sphere0, BABYLON.PhysicsImpostor.MeshImpostor, boxImpostorParams, scene);
			physicsViewer.showImpostor(sphere0.physicsImpostor);
        }
        });
        var pointerDragBehavior = new BABYLON.PointerDragBehavior({dragAxis: new BABYLON.Vector3(1,0,0)});
        pointerDragBehavior.onDragObservable.add((event)=>{
                console.log("drag");
                console.log(event);
            })
			var perticleFromVerticesEmitter = sphere0;
        	perticleFromVerticesEmitter.useVertexColors = true;
        	
        	var verticesPositions = perticleFromVerticesEmitter.getVerticesData(BABYLON.VertexBuffer.PositionKind);
        	var verticesNormals = perticleFromVerticesEmitter.getVerticesData(BABYLON.VertexBuffer.NormalKind);        	
        	var verticesColor = [];
        

			var particleSystem = new BABYLON.ParticleSystem("particles", 30 , scene, null, true);
            particleSystem.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/ParticleSystems/Steam/T_SteamSpriteSheet.png", scene, true,
            false, BABYLON.Texture.TRILINEAR_SAMPLINGMODE);

            particleSystem.startSpriteCellID = 0;
            particleSystem.endSpriteCellID = 31;
            particleSystem.spriteCellHeight = 256;
            particleSystem.spriteCellWidth = 128;
            particleSystem.spriteCellChangeSpeed = 4;

            particleSystem.minScaleX = 1.0;
            particleSystem.minScaleY = 6.0;
            particleSystem.maxScaleX = 1.0;
            particleSystem.maxScaleY = 2.0;

            particleSystem.addSizeGradient(1.0, 1.0, 1.0);
            particleSystem.addSizeGradient(1.0, 3, 1);

            particleSystem.translationPivot = new BABYLON.Vector2(0, -0.5);

            // Where the particles come from
            var radius = 10.4;
            var angle = Math.PI;
           // var coneEmitter = new BABYLON.ConeParticleEmitter(radius, angle);

          //  particleSystem.particleEmitterType = coneEmitter;
            particleSystem.emitter= new BABYLON.Vector3(0, 0, 0);

            // Life time of each particle (random between...
            particleSystem.minLifeTime = 1.0;
            particleSystem.maxLifeTime = 4.0;

            // Color gradient over life
            particleSystem.addColorGradient(0, new BABYLON.Color4(1, 1, 1, 0));
            particleSystem.addColorGradient(0.5, new BABYLON.Color4(1, 1, 1, 70/255));
            particleSystem.addColorGradient(1.0, new BABYLON.Color4(1, 1, 1, 0));

            // Emission rate
            particleSystem.emitRate = 60000 ;

            // Blend mode : BLENDMODE_ONEONE, or BLENDMODE_STANDARD
            particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ADD;

            // Set the gravity of all particles
            particleSystem.gravity = new BABYLON.Vector3(0, 1, 1);

            // Speed
            particleSystem.minEmitPower = 0;
            particleSystem.maxEmitPower = 0 ;
            particleSystem.updateSpeed = 1/60;

            // Start the particle system
            particleSystem.start();

            // Let's try our built-in 'ground' shape.  Params: name, width, depth, subdivisions, scene
            // var ground = BABYLON.Mesh.CreateGround("ground1", 10, 10, 2, scene);
            // ground.material = new BABYLON.StandardMaterial("hoho", scene);
            // ground.position.y = -2;
        
            // Animations
            var frame_count = 0;
            scene.beforeRender = function () {
                 light0.position.copyFromFloats(5.0 * Math.sin(frame_count/100),
                                                2.0,
                                                5.0 * Math.cos(frame_count/100) );
                 light1.position.copyFromFloats(5.0 * Math.cos(2*frame_count/100),
                                                2.0 + 5.0 * Math.sin(2*frame_count/100),
                                                2.0                   );
        
                // Make sphere visible with increasing details every 100 frame
                // detail in 0, 1, 2, 3, 4
                // flat in 0, 1
                showdetail = Math.floor((frame_count/64))%(detail_count*2);
                showflat = (showdetail>=detail_count);
                detail = showdetail % detail_count;
                frame_count ++;
            };
        <!-- document.onkeydown = ()=>{ -->
                <!-- pointerDragBehavior.dragging ? pointerDragBehavior.releaseDrag() : pointerDragBehavior.startDrag(55) -->
                
            <!-- } -->
            <!-- sphere0.addBehavior(pointerDragBehavior); -->
            // Leave this function
            return scene;
        
        };  // End of createScene function
        
__createScene = createScene;
        
        var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
        var scene = createScene();

        engine.runRenderLoop(function () {
            if (scene) {
                scene.render();
            }
        });

        // Resize
        <!-- window.addEventListener("resize", function () { -->
            <!-- engine.resize(); -->
        <!-- }); -->
    </script>
</body>

</html>
